generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////
// User and Profile //
//////////////////////

model User {
  id                     String                   @id @default(cuid())
  email                  String                   @unique
  password               String
  title                  String?
  name                   String
  avatarUrl              String?
  isEmailVerified        Boolean                  @default(false)
  role                   String
  phoneNumber            String?
  address                String?
  preferredVoiceId       String?

  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt

  profile                Profile?
  sessions               Session[]
  tokens                 Token[]
  kids                   Kid[]
  voices                 Voice[]
  rewards                Reward[]
  notificationPreferences NotificationPreference[]
  activityLogs           ActivityLog[]

  preferredVoice         Voice?                   @relation("UserPreferredVoice", fields: [preferredVoiceId], references: [id])
}

model Profile {
  id                String   @id @default(cuid())
  userId            String   @unique
  explicitContent   Boolean  @default(false)
  maxScreenTimeMins Int      @default(0)
  language          String   @default("en")
  country           String   @default("unknown")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id])
}

//////////////////////
// Auth Models //
//////////////////////

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
}

model Token {
  id        String   @id @default(cuid())
  userId    String
  token     String
  type      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
}

//////////////////////
// Kid and Voice //
//////////////////////

model Kid {
  id                     String   @id @default(cuid())
  name                   String
  avatarId               String?
  ageRange               String?
  favoriteColor          String?
  parentId               String
  preferredVoiceId       String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  parent                 User     @relation(fields: [parentId], references: [id])
  rewards                Reward[]
  notificationPreferences NotificationPreference[]
  activityLogs           ActivityLog[]
  storyProgress          StoryProgress[]
  favorites              Favorite[]
  storyPaths             StoryPath[]
  dailyChallengeAssignments DailyChallengeAssignment[]
  rewardRedemptions      RewardRedemption[]

  preferredVoice         Voice?   @relation("KidPreferredVoice", fields: [preferredVoiceId], references: [id])
}

model Voice {
  id                     String   @id @default(cuid())
  userId                 String
  name                   String
  type                   String
  url                    String?
  elevenLabsVoiceId      String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  user                   User     @relation(fields: [userId], references: [id])
  usersPreferring        User[]   @relation("UserPreferredVoice")
  kidsPreferring         Kid[]    @relation("KidPreferredVoice")
}

//////////////////////
// Story Models //
//////////////////////

model Story {
  id             String   @id @default(cuid())
  title          String
  description    String
  language       String
  coverImageUrl  String?
  audioUrl       String?
  textContent    String?
  isInteractive  Boolean  @default(false)
  ageMin         Int?
  ageMax         Int?
  recommended    Boolean  @default(false)
  aiGenerated    Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  genre          String?
  estimatedReadTime Int?

  storyImages    StoryImage[]
  storyBranches  StoryBranch[]
  favorites      Favorite[]
  storyProgress  StoryProgress[]
  storyPaths     StoryPath[]
  dailyChallenges DailyChallenge[]
  storyAudioCache StoryAudioCache[]
  storyQuestions  StoryQuestion[]

  categories     Category[] @relation("StoryCategories")
  themes         Theme[]    @relation("StoryThemes")
}

model StoryImage {
  id        String   @id @default(cuid())
  url       String
  caption   String?
  storyId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  story     Story    @relation(fields: [storyId], references: [id])
}

model StoryBranch {
  id        String   @id @default(cuid())
  storyId   String
  prompt    String
  optionA   String
  optionB   String
  nextA     String?
  nextB     String?
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  story     Story    @relation(fields: [storyId], references: [id])
}

model Favorite {
  id        String   @id @default(cuid())
  kidId     String
  storyId   String
  createdAt DateTime @default(now())

  kid       Kid      @relation(fields: [kidId], references: [id])
  story     Story    @relation(fields: [storyId], references: [id])
}

model StoryProgress {
  id          String   @id @default(cuid())
  kidId       String
  storyId     String
  progress    Float    @default(0)
  completed   Boolean  @default(false)
  lastAccessed DateTime @default(now())
  @@unique([kidId, storyId])

  kid         Kid      @relation(fields: [kidId], references: [id])
  story       Story    @relation(fields: [storyId], references: [id])
}

//////////////////////
// Daily Challenges //
//////////////////////

model DailyChallenge {
  id            String   @id @default(cuid())
  storyId       String
  challengeDate DateTime
  wordOfTheDay  String
  meaning       String

  story         Story    @relation(fields: [storyId], references: [id])
  assignments   DailyChallengeAssignment[]
}

model DailyChallengeAssignment {
  id          String   @id @default(cuid())
  kidId       String
  challengeId String
  completed   Boolean  @default(false)
  completedAt DateTime?
  assignedAt  DateTime @default(now())

  kid         Kid      @relation(fields: [kidId], references: [id])
  challenge   DailyChallenge @relation(fields: [challengeId], references: [id])
}

//////////////////////
// Rewards //
//////////////////////

model Reward {
  id            String   @id @default(cuid())
  name          String
  description   String?
  points        Int
  imageUrl      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  userId        String?
  kidId         String?
  expiresAt     DateTime?
  isActive      Boolean  @default(true)

  user          User?    @relation(fields: [userId], references: [id])
  kid           Kid?     @relation(fields: [kidId], references: [id])
  redemptions   RewardRedemption[]
}

model RewardRedemption {
  id            String   @id @default(cuid())
  rewardId      String
  kidId         String
  redeemedAt    DateTime @default(now())
  status        String
  pointsRedeemed Int
  comment       String?

  reward        Reward   @relation(fields: [rewardId], references: [id])
  kid           Kid      @relation(fields: [kidId], references: [id])
}

//////////////////////
// Notifications //
//////////////////////

model NotificationPreference {
  id        String   @id @default(cuid())
  type      String
  enabled   Boolean  @default(true)
  userId    String?
  kidId     String?
  pushToken String?
  frequency String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User?    @relation(fields: [userId], references: [id])
  kid       Kid?     @relation(fields: [kidId], references: [id])
}

//////////////////////
// Activity Logs //
//////////////////////

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String?
  kidId     String?
  action    String
  details   String?
  createdAt DateTime @default(now())
  device    String?
  ipAddress String?

  user      User?    @relation(fields: [userId], references: [id])
  kid       Kid?     @relation(fields: [kidId], references: [id])
}

//////////////////////
// Story Paths //
//////////////////////

model StoryPath {
  id          String   @id @default(cuid())
  kidId       String
  storyId     String
  path        String
  startedAt   DateTime @default(now())
  completedAt DateTime?

  kid         Kid      @relation(fields: [kidId], references: [id])
  story       Story    @relation(fields: [storyId], references: [id])
}

//////////////////////
// Categories & Themes //
//////////////////////



model Theme {
  id        String   @id @default(cuid())
  name      String   @unique
  image     String?
  description String?
  isPremium Boolean @default(false)

  stories   Story[]  @relation("StoryThemes")
}

model Category {
  id        String   @id @default(cuid())
  name      String   @unique
  image     String?
  description String?
  parentCategoryId String?

  stories   Story[]  @relation("StoryCategories")
}


//////////////////////
// Story Extras //
//////////////////////

model StoryAudioCache {
  id        String   @id @default(cuid())
  storyId   String
  voiceType String
  audioUrl  String
  duration  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  story     Story    @relation(fields: [storyId], references: [id])
}

model StoryQuestion {
  id        String   @id @default(cuid())
  storyId   String
  question  String
  options   String[]
  answer    Int
  explanation String?

  story     Story    @relation(fields: [storyId], references: [id])
}

enum Role {
  admin
  parent
  kid
}
