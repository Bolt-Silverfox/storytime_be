generator client {
  provider      = "prisma-client-js"
  engineType    = "binary"
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  parent
  kid
}

enum NotificationType {
  email
  push
}

model User {
  id              String   @id @default(uuid())
  email           String   @unique
  passwordHash    String
  title           String?
  name            String?
  avatarId        String?
  avatar          Avatar?  @relation(fields: [avatarId], references: [id])
  isEmailVerified Boolean  @default(false)
  role            Role     @default(parent)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  pinHash         String?

  enableBiometrics Boolean? @default(false)

  profile Profile?
  auth    Session[]
  Token   Token[]
  kids    Kid[]

  voices           Voice[]
  preferredVoiceId String?
  preferredVoice   Voice?  @relation("PreferredVoice", fields: [preferredVoiceId], references: [id])

  Reward                  Reward[]
  notificationPreferences NotificationPreference[]
  activityLogs            ActivityLog[]
  userIps                 UserIP[]

  googleId String? @unique

  //PAYMENT MODELS RESTORED
  subscriptions       Subscription[]
  supportTickets      SupportTicket[]
  paymentMethods      PaymentMethod[]
  paymentTransactions PaymentTransaction[]

  @@map("users")
}

// -------------------------
// KID MODEL
// -------------------------
model Kid {
  id                       String              @id @default(uuid())
  name                     String?
  avatarId                 String?
  avatar                   Avatar?             @relation(fields: [avatarId], references: [id])
  ageRange                 String?
  dailyScreenTimeLimitMins Int?
  screenTimeSessions       ScreenTimeSession[]
  questionAnswers          QuestionAnswer[]

  parentId String
  parent   User   @relation(fields: [parentId], references: [id], onDelete: Cascade)

  currentReadingLevel Int      @default(1)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  rewards          Reward[]
  preferredVoiceId String?
  preferredVoice   Voice?   @relation("KidPreferredVoice", fields: [preferredVoiceId], references: [id])

  preferredCategories Category[] @relation("KidPreferredCategories")
  excludedTags        String[]   @default([])

  isBedtimeEnabled Boolean @default(false)
  bedtimeStart     String? // Format: "HH:mm" e.g., "20:00"
  bedtimeEnd       String? // Format: "HH:mm" e.g., "07:00"
  bedtimeDays      Int[]   @default([]) // 0=Sunday, 1=Monday, etc.

  bedtimeLockApp     Boolean @default(false) // "Lock app during bedtime"
  bedtimeDimScreen   Boolean @default(false) // "Dim screen during bedtime"
  bedtimeReminder    Boolean @default(false) // "Show bedtime reminder"
  bedtimeStoriesOnly Boolean @default(false) // "Allow bedtime stories only"

  // New relations
  dailyChallenges         DailyChallengeAssignment[]
  notificationPreferences NotificationPreference[]
  rewardRedemptions       RewardRedemption[]
  activityLogs            ActivityLog[]
  storyPaths              StoryPath[]
  favorites               Favorite[]
  progresses              StoryProgress[]

  @@map("kids")
}

// -------------------------
// SESSION / TOKEN / PROFILE
// -------------------------
model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, token])
  @@map("sessions")
}

model Token {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  type      String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, type])
  @@index([userId, token])
  @@map("tokens")
}

model Profile {
  id                String   @id @default(uuid())
  user              User     @relation(fields: [userId], references: [id])
  userId            String   @unique
  explicitContent   Boolean  @default(true)
  maxScreenTimeMins Int?
  language          String?
  country           String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("profiles")
}

// -------------------------
// STORY MODELS
// -------------------------
model Story {
  id              String   @id @default(uuid())
  title           String
  description     String
  language        String
  coverImageUrl   String
  audioUrl        String
  textContent     String?
  isInteractive   Boolean
  ageMin          Int
  ageMax          Int
  recommended     Boolean  @default(false)
  aiGenerated     Boolean  @default(false)
  difficultyLevel Int      @default(1)
  wordCount       Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  images   StoryImage[]
  branches StoryBranch[]

  favorites       Favorite[]
  progresses      StoryProgress[]
  dailyChallenges DailyChallenge[]
  paths           StoryPath[]

  categories       Category[]        @relation("StoryCategories")
  themes           Theme[]           @relation("StoryThemes")
  storyAudioCaches StoryAudioCache[]
  questions        StoryQuestion[]

  @@map("stories")
}

model StoryImage {
  id        String   @id @default(uuid())
  url       String
  caption   String?
  storyId   String
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("story_images")
}

model StoryBranch {
  id        String   @id @default(uuid())
  storyId   String
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  prompt    String
  optionA   String
  optionB   String
  nextA     String?
  nextB     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("story_branches")
}

model Favorite {
  id        String   @id @default(uuid())
  kidId     String
  kid       Kid      @relation(fields: [kidId], references: [id], onDelete: Cascade)
  storyId   String
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@map("favorites")
}

model StoryProgress {
  id             String   @id @default(uuid())
  kidId          String
  kid            Kid      @relation(fields: [kidId], references: [id], onDelete: Cascade)
  storyId        String
  story          Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  progress       Float    @default(0)
  completed      Boolean  @default(false)
  lastAccessed   DateTime @default(now())
  totalTimeSpent Int      @default(0)

  @@unique([kidId, storyId])
  @@map("story_progress")
}

// -------------------------
// PAYMENT MODELS (RESTORED)
// -------------------------

model Subscription {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  plan      String
  status    String    @default("active")
  startedAt DateTime  @default(now())
  endsAt    DateTime?

  @@map("subscriptions")
}

model SupportTicket {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  subject   String
  message   String
  status    String   @default("open")
  createdAt DateTime @default(now())

  @@map("support_tickets")
}

model PaymentMethod {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String
  details   String
  provider  String?
  last4     String?
  expiry    String?
  meta      Json?
  createdAt DateTime @default(now())

  transactions PaymentTransaction[]

  @@map("payment_methods")
}

model PaymentTransaction {
  id              String         @id @default(uuid())
  userId          String
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  paymentMethodId String?
  paymentMethod   PaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  currency        String?
  reference       String?
  amount          Float
  status          String
  createdAt       DateTime       @default(now())

  @@map("payment_transactions")
}

// -------------------------
// DAILY CHALLENGES, VOICE, REWARD, ETC...
// -------------------------

model DailyChallenge {
  id            String                     @id @default(uuid())
  storyId       String
  story         Story                      @relation(fields: [storyId], references: [id], onDelete: Cascade)
  challengeDate DateTime
  wordOfTheDay  String
  meaning       String
  assignments   DailyChallengeAssignment[]

  @@map("daily_challenges")
}

model Voice {
  id                String   @id @default(uuid())
  userId            String?
  user              User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  name              String
  type              String
  url               String?
  elevenLabsVoiceId String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  usersPreferring User[] @relation("PreferredVoice")
  kidsPreferring  Kid[]  @relation("KidPreferredVoice")

  @@index([name])
  @@map("voices")
}

model Reward {
  id          String   @id @default(uuid())
  name        String
  description String?
  points      Int
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  kidId String?
  kid   Kid?    @relation(fields: [kidId], references: [id])

  redemptions RewardRedemption[]

  @@map("rewards")
}

model DailyChallengeAssignment {
  id          String         @id @default(uuid())
  kidId       String
  kid         Kid            @relation(fields: [kidId], references: [id], onDelete: Cascade)
  challengeId String
  challenge   DailyChallenge @relation(fields: [challengeId], references: [id])
  completed   Boolean        @default(false)
  completedAt DateTime?
  assignedAt  DateTime       @default(now())

  @@map("daily_challenge_assignments")
}

model NotificationPreference {
  id      String           @id @default(uuid())
  type    NotificationType
  enabled Boolean          @default(true)

  userId String?
  kidId  String?

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)
  kid  Kid?  @relation(fields: [kidId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("notification_preferences")
}

model RewardRedemption {
  id         String   @id @default(uuid())
  rewardId   String
  reward     Reward   @relation(fields: [rewardId], references: [id])
  kidId      String
  kid        Kid      @relation(fields: [kidId], references: [id], onDelete: Cascade)
  redeemedAt DateTime @default(now())
  status     String

  @@map("reward_redemptions")
}

model ActivityLog {
  id          String   @id @default(uuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  kidId       String?
  kid         Kid?     @relation(fields: [kidId], references: [id])
  action      String   // e.g. 'story_read', 'reward_redeemed', etc.
  status      String   // NEW: 'SUCCESS', 'FAILED', etc.
  deviceName  String?  // NEW: e.g. 'iPhone 13'
  deviceModel String?  // NEW: e.g. 'A2482'
  os          String?  // NEW: e.g. 'iOS 17'
  ipAddress   String?  // NEW: e.g. '102.89.33.110'
  details     String?
  createdAt   DateTime @default(now())

  @@map("activity_logs")
}

model StoryPath {
  id          String    @id @default(uuid())
  kidId       String
  kid         Kid       @relation(fields: [kidId], references: [id], onDelete: Cascade)
  storyId     String
  story       Story     @relation(fields: [storyId], references: [id])
  path        String // JSON or delimited string of choices
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  @@map("story_paths")
}

model Category {
  id              String  @id @default(uuid())
  name            String  @unique
  image           String?
  description     String?
  stories         Story[] @relation("StoryCategories")
  preferredByKids Kid[]   @relation("KidPreferredCategories")
}

model Theme {
  id          String  @id @default(uuid())
  name        String  @unique
  image       String?
  description String?
  stories     Story[] @relation("StoryThemes")
}

model StoryAudioCache {
  id        String   @id @default(uuid())
  storyId   String
  voiceType String
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  audioUrl  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storyId, audioUrl])
  @@unique([storyId, voiceType])
  @@map("story_audio_cache")
}

model StoryQuestion {
  id            String           @id @default(uuid())
  storyId       String
  story         Story            @relation(fields: [storyId], references: [id], onDelete: Cascade)
  question      String
  options       String[]
  correctOption Int
  answers       QuestionAnswer[]

  @@map("story_questions")
}

model Avatar {
  id             String    @id @default(cuid())
  name           String?
  displayName    String?
  url            String
  isSystemAvatar Boolean   @default(false)
  isDeleted      Boolean   @default(false)
  deletedAt      DateTime?
  publicId       String?
  createdAt      DateTime  @default(now())

  users User[]
  kids  Kid[]

  @@unique([name])
  @@index([name])
  @@index([isSystemAvatar])
  @@map("avatars")
}

model AgeGroup {
  id        String   @id @default(uuid())
  name      String
  min       Int
  max       Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name])
  @@map("age_groups")
}

model ScreenTimeSession {
  id        String    @id @default(uuid())
  kidId     String
  kid       Kid       @relation(fields: [kidId], references: [id], onDelete: Cascade)
  startTime DateTime  @default(now())
  endTime   DateTime?
  duration  Int?
  date      DateTime  @default(now())

  @@index([kidId, date])
  @@map("screen_time_sessions")
}

model QuestionAnswer {
  id             String        @id @default(uuid())
  kidId          String
  kid            Kid           @relation(fields: [kidId], references: [id], onDelete: Cascade)
  questionId     String
  question       StoryQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  storyId        String
  selectedOption Int
  isCorrect      Boolean
  answeredAt     DateTime      @default(now())

  @@index([kidId])
  @@index([kidId, answeredAt])
  @@map("question_answers")
}

model UserIP {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ipAddress String
  userAgent String?
  firstUsed DateTime @default(now())
  lastUsed  DateTime @updatedAt

  @@unique([userId, ipAddress])
  @@index([ipAddress])
  @@map("user_ips")
}
