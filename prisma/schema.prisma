generator client {
  provider      = "prisma-client-js"
  engineType    = "binary"
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  parent
  kid
}

enum NotificationType {
  email
  push
  in_app
}

enum NotificationCategory {
  // Auth & Security
  EMAIL_VERIFICATION
  PASSWORD_RESET
  PASSWORD_RESET_ALERT
  PASSWORD_CHANGED
  PIN_RESET
  NEW_LOGIN

  // Subscription & Billing
  SUBSCRIPTION_REMINDER
  SUBSCRIPTION_ALERT
  PAYMENT_SUCCESS
  PAYMENT_FAILED

  // Engagement / Discovery
  NEW_STORY
  FEEDBACK
  STORY_FINISHED
  STORY_RECOMMENDATION
  WE_MISS_YOU

  // Reminders
  INCOMPLETE_STORY_REMINDER
  DAILY_LISTENING_REMINDER
  DAILY_CHALLENGE_REMINDER

  // Progress & Rewards
  ACHIEVEMENT_UNLOCKED
  BADGE_EARNED
  STREAK_MILESTONE

  // Parental
  SCREEN_TIME_LIMIT
  BEDTIME_REMINDER
  WEEKLY_REPORT

  // System
  SYSTEM_ALERT
}

enum OnboardingStatus {
  account_created
  email_verified
  profile_setup
  pin_setup
}

model User {
  id                      String                   @id @default(uuid())
  email                   String                   @unique
  passwordHash            String
  name                    String?
  avatarId                String?
  avatar                  Avatar?                  @relation(fields: [avatarId], references: [id])
  isEmailVerified         Boolean                  @default(false)
  onboardingStatus        OnboardingStatus         @default(account_created) // NEW FIELD
  role                    Role                     @default(parent)
  badges                  UserBadge[]
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  pinHash                 String?
  biometricsEnabled       Boolean                  @default(false)
  // SOFT DELETE FIELDS
  isDeleted               Boolean                  @default(false)
  deletedAt               DateTime?
  profile                 Profile?
  auth                    Session[]
  Token                   Token[]
  kids                    Kid[]
  parentFavorites         ParentFavorite[]
  userStoryProgress       UserStoryProgress[]
  voices                  Voice[]
  preferredVoiceId        String?
  preferredVoice          Voice?                   @relation("PreferredVoice", fields: [preferredVoiceId], references: [id])
  Reward                  Reward[]
  notificationPreferences NotificationPreference[]
  notifications           Notification[]
  preferredCategories     Category[]               @relation("UserPreferredCategories")
  activityLogs            ActivityLog[]
  userIps                 UserIP[]

  usage    UserUsage? // Relation to usage tracking
  googleId String?    @unique
  appleId  String?    @unique

  //PAYMENT MODELS RESTORED
  subscription          Subscription?
  supportTickets        SupportTicket[]
  paymentMethods        PaymentMethod[]
  paymentTransactions   PaymentTransaction[]
  // FCM device tokens for push notifications
  deviceTokens          DeviceToken[]
  // ADDED: Parent recommendations
  parentRecommendations ParentRecommendation[]
  // ADDED: Restricted stories
  restrictedStories     RestrictedStory[]
  // NEW: Learning expectations (marketing data)
  learningExpectations  UserLearningExpectation[]

  @@index([isDeleted])
  @@index([email, isDeleted])
  @@index([avatarId])
  @@index([preferredVoiceId])
  @@index([role, isDeleted])
  @@map("users")
}

// -------------------------
// KID MODEL
// -------------------------
model Kid {
  id                       String                     @id @default(uuid())
  name                     String?
  avatarId                 String?
  avatar                   Avatar?                    @relation(fields: [avatarId], references: [id])
  ageRange                 String?
  dailyScreenTimeLimitMins Int?
  screenTimeSessions       ScreenTimeSession[]
  questionAnswers          QuestionAnswer[]
  parentId                 String
  parent                   User                       @relation(fields: [parentId], references: [id], onDelete: Cascade)
  currentReadingLevel      Int                        @default(1)
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  // SOFT DELETE FIELDS
  isDeleted                Boolean                    @default(false)
  deletedAt                DateTime?
  rewards                  Reward[]
  preferredVoiceId         String?
  preferredVoice           Voice?                     @relation("KidPreferredVoice", fields: [preferredVoiceId], references: [id])
  preferredCategories      Category[]                 @relation("KidPreferredCategories")
  excludedTags             String[]                   @default([])
  isBedtimeEnabled         Boolean                    @default(false)
  bedtimeStart             String? // Format: "HH:mm" e.g., "20:00"
  bedtimeEnd               String? // Format: "HH:mm" e.g., "07:00"
  bedtimeDays              Int[]                      @default([]) // 0=Sunday, 1=Monday, etc.
  bedtimeLockApp           Boolean                    @default(false) // "Lock app during bedtime"
  bedtimeDimScreen         Boolean                    @default(false) // "Dim screen during bedtime"
  bedtimeReminder          Boolean                    @default(false) // "Show bedtime reminder"
  bedtimeStoriesOnly       Boolean                    @default(false) // "Allow bedtime stories only"
  storyBuddyId             String?
  buddySelectedAt          DateTime?
  buddyInteractions        BuddyInteraction[]
  storyBuddy               StoryBuddy?                @relation(fields: [storyBuddyId], references: [id])
  // New relations
  downloadedStories        DownloadedStory[]
  createdStories           Story[]                    @relation("CreatedStories") // Stories the kid generated
  dailyChallenges          DailyChallengeAssignment[]
  notificationPreferences  NotificationPreference[]
  rewardRedemptions        RewardRedemption[]
  activityLogs             ActivityLog[]
  storyPaths               StoryPath[]
  favorites                Favorite[]
  progresses               StoryProgress[]
  // Relation: user badges associated with this kid
  userBadges               UserBadge[]
  // ADDED: Parent recommendations
  parentRecommendations    ParentRecommendation[]
  // ADDED: Restricted stories
  restrictedStories        RestrictedStory[]

  @@index([isDeleted])
  @@index([parentId])
  @@index([parentId, isDeleted])
  @@index([avatarId])
  @@index([preferredVoiceId])
  @@index([storyBuddyId])
  @@map("kids")
}

// Relation to user badges (per-kid badges)
// Added to support UserBadge.kid relation
// Note: keep this near other relation fields
// (Prisma requires the opposite relation field)

// -------------------------
// SESSION / TOKEN / PROFILE
// -------------------------
model Session {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  // SOFT DELETE FIELDS
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  @@index([userId])
  @@index([userId, token])
  @@index([isDeleted])
  @@map("sessions")
}

model Token {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  type      String
  expiresAt DateTime
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  // SOFT DELETE FIELDS
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  @@index([userId])
  @@index([userId, type])
  @@index([userId, token])
  @@index([isDeleted])
  @@map("tokens")
}

model Profile {
  id                String    @id @default(uuid())
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId            String    @unique
  explicitContent   Boolean   @default(true)
  maxScreenTimeMins Int?
  language          String?
  languageCode      String? // "en", "es", "fr" 
  country           String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  // SOFT DELETE FIELDS
  isDeleted         Boolean   @default(false)
  deletedAt         DateTime?

  @@index([isDeleted])
  @@map("profiles")
}

model LearningExpectation {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  category    String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?

  // Relation to users who selected this
  users UserLearningExpectation[]

  @@index([isDeleted])
  @@index([isActive])
  @@map("learning_expectations")
}

// Junction table for many-to-many relationship
model UserLearningExpectation {
  id                    String              @id @default(uuid())
  userId                String
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  learningExpectationId String
  learningExpectation   LearningExpectation @relation(fields: [learningExpectationId], references: [id], onDelete: Cascade)
  selectedAt            DateTime            @default(now())
  isDeleted             Boolean             @default(false)
  deletedAt             DateTime?

  @@unique([userId, learningExpectationId])
  @@index([userId])
  @@index([learningExpectationId])
  @@index([isDeleted])
  @@map("user_learning_expectations")
}

// -------------------------
// STORY MODELS
// -------------------------
model Story {
  id                    String                 @id @default(uuid())
  title                 String
  description           String
  language              String
  coverImageUrl         String
  audioUrl              String
  textContent           String?
  isInteractive         Boolean
  ageMin                Int
  ageMax                Int
  backgroundColor       String                 @default("#5E3A54")
  recommended           Boolean                @default(false)
  aiGenerated           Boolean                @default(false)
  difficultyLevel       Int                    @default(1)
  wordCount             Int                    @default(0)
  durationSeconds       Int? // Estimated reading time in seconds
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  // SOFT DELETE FIELDS
  isDeleted             Boolean                @default(false)
  deletedAt             DateTime?
  images                StoryImage[]
  branches              StoryBranch[]
  favorites             Favorite[]
  parentFavorites       ParentFavorite[]
  progresses            StoryProgress[]
  userProgress          UserStoryProgress[]
  dailyChallenges       DailyChallenge[]
  paths                 StoryPath[]
  categories            Category[]             @relation("StoryCategories")
  themes                Theme[]                @relation("StoryThemes")
  storyAudioCaches      StoryAudioCache[]
  questions             StoryQuestion[]
  seasons               Season[]               @relation("StorySeasons")
  // Add this field to track who created it (for AI generation)
  creatorKidId          String?
  creatorKid            Kid?                   @relation("CreatedStories", fields: [creatorKidId], references: [id])
  // New Relation
  downloads             DownloadedStory[]
  // ADDED: Parent recommendations
  parentRecommendations ParentRecommendation[]
  // ADDED: Restricted stories
  restrictedStories     RestrictedStory[]

  @@index([isDeleted])
  @@index([createdAt])
  @@index([creatorKidId])
  @@index([language])
  @@index([aiGenerated, isDeleted])
  @@index([recommended, isDeleted])
  @@index([ageMin, ageMax])
  @@map("stories")
}

model StoryImage {
  id        String    @id @default(uuid())
  url       String
  caption   String?
  storyId   String
  story     Story     @relation(fields: [storyId], references: [id], onDelete: Cascade)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  // SOFT DELETE FIELDS
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  @@index([storyId])
  @@index([isDeleted])
  @@map("story_images")
}

model StoryBranch {
  id        String    @id @default(uuid())
  storyId   String
  story     Story     @relation(fields: [storyId], references: [id], onDelete: Cascade)
  prompt    String
  optionA   String
  optionB   String
  nextA     String?
  nextB     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  // SOFT DELETE FIELDS
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  @@index([storyId])
  @@index([isDeleted])
  @@map("story_branches")
}

model Favorite {
  id        String    @id @default(uuid())
  kidId     String
  kid       Kid       @relation(fields: [kidId], references: [id], onDelete: Cascade)
  storyId   String
  story     Story     @relation(fields: [storyId], references: [id], onDelete: Cascade)
  createdAt DateTime  @default(now())
  // SOFT DELETE FIELDS
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  @@index([kidId])
  @@index([storyId])
  @@index([kidId, storyId])
  @@index([isDeleted])
  @@map("favorites")
}

model ParentFavorite {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  storyId   String
  story     Story     @relation(fields: [storyId], references: [id], onDelete: Cascade)
  createdAt DateTime  @default(now())
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  @@unique([userId, storyId])
  @@index([userId])
  @@index([storyId])
  @@index([isDeleted])
  @@map("parent_favorites")
}

model StoryProgress {
  id             String    @id @default(uuid())
  kidId          String
  kid            Kid       @relation(fields: [kidId], references: [id], onDelete: Cascade)
  storyId        String
  story          Story     @relation(fields: [storyId], references: [id], onDelete: Cascade)
  progress       Float     @default(0)
  completed      Boolean   @default(false)
  lastAccessed   DateTime  @default(now())
  totalTimeSpent Int       @default(0)
  // SOFT DELETE FIELDS
  isDeleted      Boolean   @default(false)
  deletedAt      DateTime?

  @@unique([kidId, storyId])
  @@index([kidId])
  @@index([storyId])
  @@index([isDeleted])
  @@index([kidId, completed])
  @@map("story_progress")
}

model UserStoryProgress {
  id             String    @id @default(uuid())
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  storyId        String
  story          Story     @relation(fields: [storyId], references: [id], onDelete: Cascade)
  progress       Float     @default(0)
  completed      Boolean   @default(false)
  lastAccessed   DateTime  @default(now())
  totalTimeSpent Int       @default(0)
  isDeleted      Boolean   @default(false)
  deletedAt      DateTime?

  @@unique([userId, storyId])
  @@index([userId])
  @@index([storyId])
  @@index([isDeleted])
  @@map("user_story_progress")
}

// -------------------------
// PAYMENT MODELS (RESTORED)
// -------------------------
model Subscription {
  id        String    @id @default(uuid())
  userId    String    @unique
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan      String
  status    String    @default("active")
  startedAt DateTime  @default(now())
  endsAt    DateTime?
  // SOFT DELETE FIELDS
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  @@index([userId, status])
  @@index([status, isDeleted])
  @@index([isDeleted])
  @@map("subscriptions")
}

model SupportTicket {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject   String
  message   String
  status    String    @default("open")
  createdAt DateTime  @default(now())
  // SOFT DELETE FIELDS
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  @@index([userId])
  @@index([status, isDeleted])
  @@index([isDeleted])
  @@map("support_tickets")
}

model PaymentMethod {
  id           String               @id @default(uuid())
  userId       String
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  type         String
  details      String
  provider     String?
  last4        String?
  expiry       String?
  meta         Json?
  createdAt    DateTime             @default(now())
  // SOFT DELETE FIELDS
  isDeleted    Boolean              @default(false)
  deletedAt    DateTime?
  transactions PaymentTransaction[]

  @@index([userId])
  @@index([userId, isDeleted])
  @@index([isDeleted])
  @@map("payment_methods")
}

model PaymentTransaction {
  id              String         @id @default(uuid())
  userId          String
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  paymentMethodId String?
  paymentMethod   PaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  currency        String?
  reference       String?
  amount          Float
  status          String
  createdAt       DateTime       @default(now())
  // SOFT DELETE FIELDS
  isDeleted       Boolean        @default(false)
  deletedAt       DateTime?

  @@unique([reference])
  @@index([userId])
  @@index([userId, status])
  @@index([paymentMethodId])
  @@index([isDeleted])
  @@map("payment_transactions")
}

// -------------------------
// DAILY CHALLENGES, VOICE, REWARD, ETC...
// -------------------------
model DailyChallenge {
  id            String                     @id @default(uuid())
  storyId       String
  story         Story                      @relation(fields: [storyId], references: [id], onDelete: Cascade)
  challengeDate DateTime
  wordOfTheDay  String
  meaning       String
  assignments   DailyChallengeAssignment[]
  // SOFT DELETE FIELDS
  isDeleted     Boolean                    @default(false)
  deletedAt     DateTime?

  @@index([storyId])
  @@index([challengeDate])
  @@index([isDeleted])
  @@map("daily_challenges")
}

model Voice {
  id                String    @id @default(uuid())
  userId            String?
  user              User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name              String
  type              String
  url               String?
  elevenLabsVoiceId String?
  voiceAvatar       String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  // SOFT DELETE FIELDS
  isDeleted           Boolean   @default(false)
  deletedAt           DateTime?
  usersPreferring     User[]      @relation("PreferredVoice")
  kidsPreferring      Kid[]       @relation("KidPreferredVoice")
  usersWithAsSecond   UserUsage[] @relation("SecondVoiceSelection")

  @@index([userId])
  @@index([name])
  @@index([type, isDeleted])
  @@index([isDeleted])
  @@map("voices")
}

model Reward {
  id          String             @id @default(uuid())
  name        String
  description String?
  points      Int
  imageUrl    String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  // SOFT DELETE FIELDS
  isDeleted   Boolean            @default(false)
  deletedAt   DateTime?
  userId      String?
  user        User?              @relation(fields: [userId], references: [id], onDelete: Cascade)
  kidId       String?
  kid         Kid?               @relation(fields: [kidId], references: [id])
  redemptions RewardRedemption[]

  @@index([userId])
  @@index([kidId])
  @@index([isDeleted])
  @@map("rewards")
}

model DailyChallengeAssignment {
  id          String         @id @default(uuid())
  kidId       String
  kid         Kid            @relation(fields: [kidId], references: [id], onDelete: Cascade)
  challengeId String
  challenge   DailyChallenge @relation(fields: [challengeId], references: [id])
  completed   Boolean        @default(false)
  completedAt DateTime?
  assignedAt  DateTime       @default(now())
  // SOFT DELETE FIELDS
  isDeleted   Boolean        @default(false)
  deletedAt   DateTime?

  @@index([kidId])
  @@index([challengeId])
  @@index([kidId, completed])
  @@index([isDeleted])
  @@map("daily_challenge_assignments")
}

model NotificationPreference {
  id        String               @id @default(uuid())
  type      NotificationType // Channel: email, push, in_app
  category  NotificationCategory // What kind of notification
  enabled   Boolean              @default(true)
  userId    String?
  kidId     String?
  user      User?                @relation(fields: [userId], references: [id], onDelete: Cascade)
  kid       Kid?                 @relation(fields: [kidId], references: [id], onDelete: Cascade)
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt
  // SOFT DELETE FIELDS
  isDeleted Boolean              @default(false)
  deletedAt DateTime?

  @@unique([userId, category, type])
  @@unique([kidId, category, type])
  @@index([isDeleted])
  @@map("notification_preferences")
}

model Notification {
  id        String               @id @default(uuid())
  userId    String
  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  category  NotificationCategory
  title     String
  body      String
  data      Json?
  isRead    Boolean              @default(false)
  createdAt DateTime             @default(now())
  isDeleted Boolean              @default(false)
  deletedAt DateTime?

  @@index([userId, createdAt])
  @@index([userId, isRead])
  @@index([isDeleted])
  @@map("notifications")
}

model RewardRedemption {
  id         String    @id @default(uuid())
  rewardId   String
  reward     Reward    @relation(fields: [rewardId], references: [id])
  kidId      String
  kid        Kid       @relation(fields: [kidId], references: [id], onDelete: Cascade)
  redeemedAt DateTime  @default(now())
  status     String
  // SOFT DELETE FIELDS
  isDeleted  Boolean   @default(false)
  deletedAt  DateTime?

  @@index([rewardId])
  @@index([kidId])
  @@index([kidId, redeemedAt])
  @@index([isDeleted])
  @@map("reward_redemptions")
}

model ActivityLog {
  id          String    @id @default(uuid())
  userId      String?
  user        User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  kidId       String?
  kid         Kid?      @relation(fields: [kidId], references: [id])
  action      String // e.g. 'story_read', 'reward_redeemed', etc.
  status      String // NEW: 'SUCCESS', 'FAILED', etc.
  deviceName  String? // NEW: e.g. 'iPhone 13'
  deviceModel String? // NEW: e.g. 'A2482'
  os          String? // NEW: e.g. 'iOS 17'
  ipAddress   String? // NEW: e.g. '102.89.33.110'
  details     String?
  createdAt   DateTime  @default(now())
  // SOFT DELETE FIELDS
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?

  @@index([userId])
  @@index([userId, createdAt])
  @@index([isDeleted])
  @@index([kidId, createdAt])
  @@index([action, createdAt])
  @@map("activity_logs")
}

model StoryPath {
  id          String    @id @default(uuid())
  kidId       String
  kid         Kid       @relation(fields: [kidId], references: [id], onDelete: Cascade)
  storyId     String
  story       Story     @relation(fields: [storyId], references: [id])
  path        String // JSON or delimited string of choices
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  // SOFT DELETE FIELDS
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?

  @@index([kidId])
  @@index([storyId])
  @@index([kidId, storyId])
  @@index([isDeleted])
  @@map("story_paths")
}

model Category {
  id               String    @id @default(uuid())
  name             String    @unique
  image            String?
  description      String?
  stories          Story[]   @relation("StoryCategories")
  preferredByKids  Kid[]     @relation("KidPreferredCategories")
  preferredByUsers User[]    @relation("UserPreferredCategories")
  // SOFT DELETE FIELDS
  isDeleted        Boolean   @default(false)
  deletedAt        DateTime?

  @@index([isDeleted])
}

model Theme {
  id          String    @id @default(uuid())
  name        String    @unique
  image       String?
  description String?
  stories     Story[]   @relation("StoryThemes")
  // SOFT DELETE FIELDS
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?

  @@index([isDeleted])
}

model StoryAudioCache {
  id        String    @id @default(uuid())
  storyId   String
  voiceType String
  story     Story     @relation(fields: [storyId], references: [id], onDelete: Cascade)
  audioUrl  String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  // SOFT DELETE FIELDS
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  @@unique([storyId, audioUrl])
  @@unique([storyId, voiceType])
  @@index([storyId])
  @@index([isDeleted])
  @@map("story_audio_cache")
}

model StoryQuestion {
  id            String           @id @default(uuid())
  storyId       String
  story         Story            @relation(fields: [storyId], references: [id], onDelete: Cascade)
  question      String
  options       String[]
  correctOption Int
  answers       QuestionAnswer[]
  // SOFT DELETE FIELDS
  isDeleted     Boolean          @default(false)
  deletedAt     DateTime?

  @@index([storyId])
  @@index([isDeleted])
  @@map("story_questions")
}

model Avatar {
  id             String    @id @default(cuid())
  name           String?
  displayName    String?
  url            String
  isSystemAvatar Boolean   @default(false)
  isDeleted      Boolean   @default(false)
  deletedAt      DateTime?
  publicId       String?
  createdAt      DateTime  @default(now())
  users          User[]
  kids           Kid[]

  @@unique([name])
  @@index([name])
  @@index([isSystemAvatar])
  @@map("avatars")
}

model AgeGroup {
  id        String    @id @default(uuid())
  name      String
  min       Int
  max       Int
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  // SOFT DELETE FIELDS
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  @@unique([name])
  @@index([isDeleted])
  @@map("age_groups")
}

model ScreenTimeSession {
  id        String    @id @default(uuid())
  kidId     String
  kid       Kid       @relation(fields: [kidId], references: [id], onDelete: Cascade)
  startTime DateTime  @default(now())
  endTime   DateTime?
  duration  Int?
  date      DateTime  @default(now())
  // SOFT DELETE FIELDS
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  @@index([kidId])
  @@index([kidId, date])
  @@index([isDeleted])
  @@map("screen_time_sessions")
}

model QuestionAnswer {
  id             String        @id @default(uuid())
  kidId          String
  kid            Kid           @relation(fields: [kidId], references: [id], onDelete: Cascade)
  questionId     String
  question       StoryQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  storyId        String
  selectedOption Int
  isCorrect      Boolean
  answeredAt     DateTime      @default(now())
  // SOFT DELETE FIELDS
  isDeleted      Boolean       @default(false)
  deletedAt      DateTime?

  @@index([kidId])
  @@index([questionId])
  @@index([storyId])
  @@index([kidId, answeredAt])
  @@index([isDeleted])
  @@map("question_answers")
}

model UserIP {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  ipAddress String
  userAgent String?
  firstUsed DateTime  @default(now())
  lastUsed  DateTime  @updatedAt
  // SOFT DELETE FIELDS
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  @@unique([userId, ipAddress])
  @@index([ipAddress])
  @@index([isDeleted])
  @@map("user_ips")
}

model StoryBuddy {
  id                String             @id @default(uuid())
  name              String             @unique
  displayName       String
  description       String?
  type              String
  imageUrl          String
  profileAvatarUrl  String?
  isActive          Boolean            @default(true)
  themeColor        String?
  ageGroupMin       Int                @default(3)
  ageGroupMax       Int                @default(12)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  // SOFT DELETE FIELDS
  isDeleted         Boolean            @default(false)
  deletedAt         DateTime?
  buddyInteractions BuddyInteraction[]
  kids              Kid[]

  @@index([isDeleted])
  @@map("story_buddies")
}

model BuddyInteraction {
  id              String     @id @default(uuid())
  kidId           String
  buddyId         String
  interactionType String
  context         String?
  message         String?
  timestamp       DateTime   @default(now())
  buddy           StoryBuddy @relation(fields: [buddyId], references: [id])
  kid             Kid        @relation(fields: [kidId], references: [id], onDelete: Cascade)
  // SOFT DELETE FIELDS
  isDeleted       Boolean    @default(false)
  deletedAt       DateTime?

  @@index([kidId, timestamp])
  @@index([buddyId])
  @@index([isDeleted])
  @@map("buddy_interactions")
}

model Badge {
  id              String      @id @default(uuid())
  title           String
  description     String?
  iconUrl         String?
  unlockCondition String
  badgeType       String // "count", "streak", "time", "special"
  requiredAmount  Int         @default(1)
  priority        Int         @default(0) // Higher = more important for preview
  metadata        Json? // Flexible storage for badge rules
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  // SOFT DELETE FIELDS
  isDeleted       Boolean     @default(false)
  deletedAt       DateTime?
  userBadges      UserBadge[]

  @@index([isDeleted])
  @@map("badges")
}

model UserBadge {
  id         String    @id @default(uuid())
  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  kidId      String?
  kid        Kid?      @relation(fields: [kidId], references: [id], onDelete: Cascade)
  badgeId    String
  badge      Badge     @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  count      Int       @default(0) // Current progress count
  unlocked   Boolean   @default(false)
  unlockedAt DateTime?
  // SOFT DELETE FIELDS
  isDeleted  Boolean   @default(false)
  deletedAt  DateTime?

  @@unique([userId, kidId, badgeId])
  @@index([userId])
  @@index([kidId])
  @@index([badgeId])
  @@index([isDeleted])
  @@map("user_badges")
}

model Season {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  iconUrl     String?
  startDate   String? // "MM-DD" generic start (approx)
  endDate     String? // "MM-DD" generic end (approx)
  stories     Story[]   @relation("StorySeasons")
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  // SOFT DELETE FIELDS
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?

  @@index([isDeleted])
  @@map("seasons")
}

model DownloadedStory {
  id           String   @id @default(uuid())
  kidId        String
  kid          Kid      @relation(fields: [kidId], references: [id], onDelete: Cascade)
  storyId      String
  story        Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  downloadedAt DateTime @default(now())

  @@unique([kidId, storyId]) // Prevent duplicate downloads
  @@index([kidId])
  @@index([storyId])
  @@map("downloaded_stories")
}

// -------------------------
// PARENT RECOMMENDATIONS
// -------------------------
model ParentRecommendation {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  kidId         String
  kid           Kid       @relation(fields: [kidId], references: [id], onDelete: Cascade)
  storyId       String
  story         Story     @relation(fields: [storyId], references: [id], onDelete: Cascade)
  // Optional message from parent
  message       String?
  // Timestamps
  recommendedAt DateTime  @default(now())
  // SOFT DELETE FIELDS
  isDeleted     Boolean   @default(false)
  deletedAt     DateTime?

  @@unique([userId, kidId, storyId])
  @@index([isDeleted])
  @@index([kidId])
  @@index([userId, kidId])
  @@map("parent_recommendations")
}

// -------------------------
// RESTRICTED STORIES
// -------------------------
model RestrictedStory {
  id        String   @id @default(uuid())
  kidId     String
  kid       Kid      @relation(fields: [kidId], references: [id], onDelete: Cascade)
  storyId   String
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reason    String?
  createdAt DateTime @default(now())

  @@unique([kidId, storyId])
  @@index([kidId])
  @@index([storyId])
  @@index([userId])
  @@map("restricted_stories")
}

// -------------------------
// USAGE TRACKING
// -------------------------
model UserUsage {
  id               String @id @default(uuid())
  userId           String @unique
  user             User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  elevenLabsCount  Int    @default(0)
  geminiStoryCount Int    @default(0)
  geminiImageCount Int    @default(0)
  currentMonth     String // Format: "YYYY-MM" to track resets

  // Free tier story quota
  uniqueStoriesRead  Int       @default(0) // Lifetime count of unique stories accessed
  bonusStories       Int       @default(0) // Accumulated weekly bonus stories
  lastBonusGrantedAt DateTime? // When last weekly bonus was granted

  // Free tier voice quota
  selectedSecondVoiceId String?   // The one custom voice free users can select (beyond default)
  selectedSecondVoice   Voice?    @relation("SecondVoiceSelection", fields: [selectedSecondVoiceId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_usages")
}

// -------------------------
// FCM DEVICE TOKENS
// -------------------------
model DeviceToken {
  id         String    @id @default(uuid())
  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token      String    @unique
  platform   String // "ios", "android", "web"
  deviceName String? // Optional device identifier
  isActive   Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  // SOFT DELETE FIELDS
  isDeleted  Boolean   @default(false)
  deletedAt  DateTime?

  @@index([userId, isActive])
  @@index([token])
  @@index([isDeleted])
  @@map("device_tokens")
}
