generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
  engineType    = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Kid {
  id                       String                     @id @default(uuid())
  name                     String?
  parentId                 String
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  preferredVoiceId         String?
  ageRange                 String?
  avatarId                 String?
  dailyScreenTimeLimitMins Int?
  activityLogs             ActivityLog[]
  dailyChallenges          DailyChallengeAssignment[]
  favorites                Favorite[]
  avatar                   Avatar?                    @relation(fields: [avatarId], references: [id])
  parent                   users                      @relation(fields: [parentId], references: [id], onDelete: Cascade)
  preferredVoice           Voice?                     @relation("KidPreferredVoice", fields: [preferredVoiceId], references: [id])
  notificationPreferences  NotificationPreference[]
  questionAnswers          QuestionAnswer[]
  rewardRedemptions        RewardRedemption[]
  rewards                  Reward[]
  screenTimeSessions       ScreenTimeSession[]
  storyPaths               StoryPath[]
  progresses               StoryProgress[]

  @@map("kids")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, token])
  @@map("sessions")
}

model Token {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  type      String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, type])
  @@index([userId, token])
  @@map("tokens")
}

model Profile {
  id                String   @id @default(uuid())
  userId            String   @unique
  explicitContent   Boolean  @default(true)
  maxScreenTimeMins Int?
  language          String?
  country           String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              users    @relation(fields: [userId], references: [id])

  @@map("profiles")
}

model Story {
  id               String            @id @default(uuid())
  title            String
  description      String
  language         String
  coverImageUrl    String
  audioUrl         String
  isInteractive    Boolean
  ageMin           Int
  ageMax           Int
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  recommended      Boolean           @default(false)
  textContent      String?
  aiGenerated      Boolean           @default(false)
  StoryThemes      StoryThemes[]
  dailyChallenges  DailyChallenge[]
  favorites        Favorite[]
  storyAudioCaches StoryAudioCache[]
  branches         StoryBranch[]
  images           StoryImage[]
  paths            StoryPath[]
  progresses       StoryProgress[]
  questions        StoryQuestion[]
  categories       Category[]        @relation("StoryCategories")

  @@map("stories")
}

model StoryImage {
  id        String   @id @default(uuid())
  url       String
  caption   String?
  storyId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@map("story_images")
}

model StoryBranch {
  id        String   @id @default(uuid())
  storyId   String
  prompt    String
  optionA   String
  optionB   String
  nextA     String?
  nextB     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@map("story_branches")
}

model Favorite {
  id        String   @id @default(uuid())
  storyId   String
  createdAt DateTime @default(now())
  kidId     String
  kid       Kid      @relation(fields: [kidId], references: [id], onDelete: Cascade)
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@map("favorites")
}

model StoryProgress {
  id           String   @id @default(uuid())
  storyId      String
  progress     Float    @default(0)
  completed    Boolean  @default(false)
  lastAccessed DateTime @default(now())
  kidId        String
  kid          Kid      @relation(fields: [kidId], references: [id], onDelete: Cascade)
  story        Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([kidId, storyId])
  @@map("story_progress")
}

model DailyChallenge {
  id            String                     @id @default(uuid())
  storyId       String
  challengeDate DateTime
  wordOfTheDay  String
  meaning       String
  assignments   DailyChallengeAssignment[]
  story         Story                      @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@map("daily_challenges")
}

model Voice {
  id                                   String   @id @default(uuid())
  userId                               String?
  name                                 String
  type                                 String
  url                                  String?
  elevenLabsVoiceId                    String?
  createdAt                            DateTime @default(now())
  updatedAt                            DateTime @updatedAt
  kidsPreferring                       Kid[]    @relation("KidPreferredVoice")
  users_users_preferredVoiceIdTovoices users[]  @relation("users_preferredVoiceIdTovoices")
  user                                 users?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([name])
  @@index([elevenLabsVoiceId])
  @@map("voices")
}

model Reward {
  id          String             @id @default(uuid())
  name        String
  description String?
  points      Int
  imageUrl    String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  userId      String?
  kidId       String?
  redemptions RewardRedemption[]
  kid         Kid?               @relation(fields: [kidId], references: [id])
  user        users?             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("rewards")
}

model DailyChallengeAssignment {
  id          String         @id @default(uuid())
  kidId       String
  challengeId String
  completed   Boolean        @default(false)
  completedAt DateTime?
  assignedAt  DateTime       @default(now())
  challenge   DailyChallenge @relation(fields: [challengeId], references: [id])
  kid         Kid            @relation(fields: [kidId], references: [id])

  @@map("daily_challenge_assignments")
}

model NotificationPreference {
  id        String           @id @default(uuid())
  userId    String?
  kidId     String?
  enabled   Boolean
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  type      NotificationType
  Kid       Kid?             @relation(fields: [kidId], references: [id])
  user      users?           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model RewardRedemption {
  id         String   @id @default(uuid())
  rewardId   String
  kidId      String
  redeemedAt DateTime @default(now())
  status     String
  kid        Kid      @relation(fields: [kidId], references: [id])
  reward     Reward   @relation(fields: [rewardId], references: [id])

  @@map("reward_redemptions")
}

model ActivityLog {
  id        String   @id @default(uuid())
  userId    String?
  kidId     String?
  action    String
  details   String?
  createdAt DateTime @default(now())
  kid       Kid?     @relation(fields: [kidId], references: [id])
  user      users?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("activity_logs")
}

model StoryPath {
  id          String    @id @default(uuid())
  kidId       String
  storyId     String
  path        String
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  kid         Kid       @relation(fields: [kidId], references: [id])
  story       Story     @relation(fields: [storyId], references: [id])

  @@map("story_paths")
}

model Category {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?
  image       String?
  stories     Story[] @relation("StoryCategories")
}

model Theme {
  id          String        @id @default(uuid())
  name        String        @unique
  description String?
  image       String?
  StoryThemes StoryThemes[]
}

model StoryAudioCache {
  id        String   @id @default(uuid())
  storyId   String
  voiceType String
  audioUrl  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([storyId, audioUrl])
  @@unique([storyId, voiceType])
  @@map("story_audio_cache")
}

model StoryQuestion {
  id            String           @id @default(uuid())
  storyId       String
  question      String
  options       String[]
  correctOption Int
  answers       QuestionAnswer[]
  story         Story            @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@map("story_questions")
}

model Avatar {
  id             String   @id @default(cuid())
  name           String?  @unique
  displayName    String?
  url            String
  isSystemAvatar Boolean  @default(false)
  publicId       String?
  createdAt      DateTime @default(now())
  kids           Kid[]
  users          users[]

  @@index([name])
  @@index([isSystemAvatar])
  @@map("avatars")
}

model AgeGroup {
  id        String   @id @default(uuid())
  name      String   @unique
  min       Int
  max       Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("age_groups")
}

model ScreenTimeSession {
  id        String    @id @default(uuid())
  kidId     String
  startTime DateTime  @default(now())
  endTime   DateTime?
  duration  Int?
  date      DateTime  @default(now())
  kid       Kid       @relation(fields: [kidId], references: [id], onDelete: Cascade)

  @@index([kidId, date])
  @@map("screen_time_sessions")
}

model QuestionAnswer {
  id             String        @id @default(uuid())
  kidId          String
  questionId     String
  storyId        String
  selectedOption Int
  isCorrect      Boolean
  answeredAt     DateTime      @default(now())
  kid            Kid           @relation(fields: [kidId], references: [id], onDelete: Cascade)
  question       StoryQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([kidId])
  @@index([kidId, answeredAt])
  @@map("question_answers")
}

model StoryThemes {
  A       String
  B       String
  stories Story  @relation(fields: [A], references: [id], onDelete: Cascade)
  Theme   Theme  @relation(fields: [B], references: [id], onDelete: Cascade)

  @@unique([A, B], map: "_StoryThemes_AB_unique")
  @@index([B], map: "_StoryThemes_B_index")
  @@map("_StoryThemes")
}

model users {
  id                                    String                   @id
  email                                 String                   @unique
  passwordHash                          String
  title                                 String?
  name                                  String?
  isEmailVerified                       Boolean                  @default(false)
  createdAt                             DateTime                 @default(now())
  updatedAt                             DateTime
  role                                  Role                     @default(parent)
  preferredVoiceId                      String?
  avatarId                              String?
  activityLogs                          ActivityLog[]
  kids                                  Kid[]
  notificationPreferences               NotificationPreference[]
  profile                               Profile?
  Reward                                Reward[]
  auth                                  Session[]
  Token                                 Token[]
  avatars                               Avatar?                  @relation(fields: [avatarId], references: [id])
  voices_users_preferredVoiceIdTovoices Voice?                   @relation("users_preferredVoiceIdTovoices", fields: [preferredVoiceId], references: [id])
  voices                                Voice[]
}

enum Role {
  admin
  parent
  kid
}

enum NotificationType {
  email
  push
}
